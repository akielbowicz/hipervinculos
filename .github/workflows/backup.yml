name: Weekly Backup

on:
  schedule:
    # Run every Sunday at 00:00 UTC
    - cron: '0 0 * * 0'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  backup:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create backup timestamp
        id: timestamp
        run: echo "date=$(date +%Y%m%d-%H%M%S)" >> $GITHUB_OUTPUT

      - name: Create backup archive
        run: |
          mkdir -p backups
          tar -czf backups/bookmarks-backup-${{ steps.timestamp.outputs.date }}.tar.gz \
            data/bookmarks.json \
            data/metadata.json \
            data/tags.json

      - name: Generate backup manifest
        run: |
          cat > backups/manifest.json <<EOF
          {
            "timestamp": "$(date -Iseconds)",
            "sha": "${{ github.sha }}",
            "total_bookmarks": $(jq '.total_bookmarks' data/metadata.json),
            "backup_file": "bookmarks-backup-${{ steps.timestamp.outputs.date }}.tar.gz",
            "files": [
              "data/bookmarks.json",
              "data/metadata.json",
              "data/tags.json"
            ]
          }
          EOF

      - name: Upload backup artifact
        uses: actions/upload-artifact@v4
        with:
          name: backup-${{ steps.timestamp.outputs.date }}
          path: backups/
          retention-days: 90

      - name: Create release for backup
        uses: softprops/action-gh-release@v1
        with:
          tag_name: backup-${{ steps.timestamp.outputs.date }}
          name: Backup ${{ steps.timestamp.outputs.date }}
          body: |
            ## Automated Backup

            **Date**: ${{ steps.timestamp.outputs.date }}
            **Commit**: ${{ github.sha }}
            **Total Bookmarks**: $(jq '.total_bookmarks' data/metadata.json)

            ### Contents

            - `bookmarks.json` - All bookmark data
            - `metadata.json` - Statistics and metadata
            - `tags.json` - Tag definitions

            ### Restore

            ```bash
            # Download and extract
            wget https://github.com/${{ github.repository }}/releases/download/backup-${{ steps.timestamp.outputs.date }}/bookmarks-backup-${{ steps.timestamp.outputs.date }}.tar.gz
            tar -xzf bookmarks-backup-${{ steps.timestamp.outputs.date }}.tar.gz

            # Copy files back
            cp data/* /path/to/repo/data/
            ```
          files: |
            backups/bookmarks-backup-${{ steps.timestamp.outputs.date }}.tar.gz
            backups/manifest.json
          draft: false
          prerelease: false

      - name: Cleanup old backups
        uses: actions/github-script@v7
        with:
          script: |
            const releases = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });

            const backupReleases = releases.data
              .filter(r => r.tag_name.startsWith('backup-'))
              .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

            // Keep last 12 backups (3 months of weekly backups)
            const toDelete = backupReleases.slice(12);

            for (const release of toDelete) {
              console.log(`Deleting old backup: ${release.tag_name}`);
              await github.rest.repos.deleteRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                release_id: release.id
              });

              // Delete the tag too
              try {
                await github.rest.git.deleteRef({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ref: `tags/${release.tag_name}`
                });
              } catch (e) {
                console.log(`Could not delete tag ${release.tag_name}: ${e.message}`);
              }
            }

            console.log(`Cleaned up ${toDelete.length} old backups`);

      - name: Backup summary
        run: |
          echo "## Backup Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp**: ${{ steps.timestamp.outputs.date }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Total bookmarks**: $(jq '.total_bookmarks' data/metadata.json)" >> $GITHUB_STEP_SUMMARY
          echo "- **Archive size**: $(du -h backups/bookmarks-backup-${{ steps.timestamp.outputs.date }}.tar.gz | cut -f1)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Backup available as release: \`backup-${{ steps.timestamp.outputs.date }}\`" >> $GITHUB_STEP_SUMMARY
