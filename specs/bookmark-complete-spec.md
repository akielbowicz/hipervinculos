# Personal Bookmark System - Complete Specification

**Version:** 3.0  
**Target:** Production-ready personal bookmark manager  
**Updated:** January 2026

---

## 1. System Overview

### 1.1 Purpose
Personal bookmark manager optimized for mobile capture and cross-device access with powerful search.

### 1.2 Core Principles
- **Mobile-first input:** Telegram bot with share sheet integration
- **Zero-friction saving:** One tap to bookmark, metadata extracted automatically
- **Powerful search:** Full-text search via Pagefind with filters
- **Browse-first:** Recent bookmarks visible without searching
- **Reliable:** Clear error states, retry mechanisms, data validation
- **Private by default:** Self-hosted, you control your data

### 1.3 User Journey

**On mobile (primary flow):**
1. Find interesting link in any app
2. Share â†’ Telegram â†’ Your bookmark bot
3. Bot responds with preview + "âœ… Saved"
4. Continue browsing

**On desktop/tablet:**
1. Open bookmarks site
2. Browse recent saves or search
3. Click to open in new tab

**Managing bookmarks:**
1. Search or browse to find bookmark
2. Use inline actions: edit title/tags, delete, toggle private
3. Changes sync instantly

---

## 2. Data Architecture

### 2.1 Bookmark Schema

```json
{
  "id": "uuid-v4",
  "url": "https://example.com/article",
  "url_normalized": "https://example.com/article",
  "url_hash": "sha256-first-16-chars",
  "title": "Article Title (max 200 chars)",
  "description": "Meta description (max 500 chars)",
  "image": "https://example.com/og-image.jpg",
  "favicon": "base64-data-uri or url",
  "content_type": "article|video|image|pdf|code|tweet|other",
  "author": "Author name if available",
  "site_name": "example.com",
  "timestamp": "2025-01-12T10:30:00.000Z",
  "modified_timestamp": "2025-01-15T14:20:00.000Z",
  "tags": ["javascript", "tutorial"],
  "is_private": false,
  "is_archived": false,
  "is_favorite": false,
  "read_status": "unread|reading|read",
  "notes": "Personal notes about this bookmark",
  "source": "telegram|browser_extension|api|import",
  "extraction_status": "success|partial|failed",
  "extraction_duration_ms": 1250
}
```

### 2.2 Storage Structure

```
/
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ bookmarks.jsonll             # All bookmarks (JSON Lines)
â”‚   â”œâ”€â”€ metadata.json               # System metadata (JSON)
â”‚   â””â”€â”€ tags.jsonl                  # Tag definitions (JSON Lines)
â”œâ”€â”€ pages/                          # HTML pages for Pagefind
â”‚   â””â”€â”€ {bookmark-id}.html
â”œâ”€â”€ pagefind/                       # Generated by Pagefind
â”‚   â”œâ”€â”€ pagefind.js
â”‚   â”œâ”€â”€ pagefind-ui.js
â”‚   â””â”€â”€ index/...
â”œâ”€â”€ assets/
â”‚   â”œâ”€â”€ styles.css
â”‚   â”œâ”€â”€ app.js
â”‚   â””â”€â”€ icons/                      # Content type icons
â”œâ”€â”€ index.html                      # Main interface
â””â”€â”€ .github/workflows/
    â””â”€â”€ build.yml
```

### 2.3 Metadata File

```json
{
  "total_bookmarks": 1247,
  "last_updated": "2025-01-12T10:30:00Z",
  "last_bookmark_id": "abc-123-def",
  "statistics": {
    "by_type": {
      "article": 450,
      "video": 120,
      "code": 80
    },
    "by_read_status": {
      "unread": 890,
      "reading": 23,
      "read": 334
    },
    "favorites_count": 45,
    "private_count": 12
  },
  "tags_usage": {
    "javascript": 145,
    "python": 89
  }
}
```

---

## 3. Telegram Bot

### 3.1 Commands

| Command | Description | Example |
|---------|-------------|---------|
| `{url}` | Save bookmark with preview | Send any URL |
| `/edit {id}` | Edit title/description/tags | `/edit abc-123` |
| `/tag {id} tag1 tag2` | Add tags | `/tag abc-123 javascript react` |
| `/untag {id} tag1` | Remove tag | `/untag abc-123 react` |
| `/delete {id}` | Delete with confirmation | `/delete abc-123` |
| `/private {id}` | Toggle private flag | `/private abc-123` |
| `/favorite {id}` | Toggle favorite | `/favorite abc-123` |
| `/read {id}` | Mark as read | `/read abc-123` |
| `/note {id} text` | Add personal note | `/note abc-123 Great intro to...` |
| `/recent [n]` | Show last n (default 5) | `/recent 10` |
| `/search query` | Search bookmarks | `/search react hooks` |
| `/stats` | Show statistics | `/stats` |
| `/tags` | List all tags with counts | `/tags` |
| `/unread` | Show unread bookmarks | `/unread` |
| `/favorites` | Show favorite bookmarks | `/favorites` |
| `/help` | Command reference | `/help` |

### 3.2 Save Flow with Preview

**User sends URL:**

1. **Immediate acknowledgment**
   ```
   â³ Fetching...
   ```

2. **Duplicate check** (if found):
   ```
   âš ï¸ Already bookmarked
   
   ğŸ“„ Article Title
   ğŸ”— https://example.com/article
   ğŸ“… Saved on Jan 10, 2025
   ğŸ†” abc-123
   
   Save anyway? This will create a duplicate.
   [âœ… Save Anyway] [ğŸ‘ï¸ View Existing]
   ```

3. **Preview card** (new bookmark):
   ```
   ğŸ“„ Article | example.com
   
   How to Build a Bookmark Manager
   A comprehensive guide to building your own
   personal bookmark system with modern tools.
   
   ğŸ”— example.com/article
   ğŸ‘¤ Jane Doe
   
   [âœ… Save] [âœï¸ Edit Before Save] [âŒ Cancel]
   ```

4. **After save confirmation**:
   ```
   âœ… Saved!
   
   ğŸ“„ How to Build a Bookmark Manager
   ğŸ†” abc-123
   ğŸ·ï¸ No tags yet
   
   [ğŸ·ï¸ Add Tags] [â­ Favorite] [ğŸ”’ Make Private]
   ```

### 3.3 Edit Flow

**User sends `/edit abc-123`:**

```
âœï¸ Edit Bookmark

Current title:
How to Build a Bookmark Manager

[âœï¸ Edit Title] [âœï¸ Edit Description] [ğŸ·ï¸ Edit Tags]
[ğŸ“ Add Note] [âŒ Cancel]
```

**After clicking "Edit Title":**
```
âœï¸ Enter new title:

(Reply to this message with new title)
```

**Confirmation:**
```
âœ… Updated!

New title: Complete Guide to Personal Bookmarking
```

### 3.4 Delete Flow

**User sends `/delete abc-123`:**

```
ğŸ—‘ï¸ Delete Bookmark?

ğŸ“„ How to Build a Bookmark Manager
ğŸ”— example.com/article
ğŸ“… Saved Jan 10, 2025

This cannot be undone.

[ğŸ—‘ï¸ Confirm Delete] [âŒ Cancel]
```

### 3.5 Search in Telegram

**User sends `/search react hooks`:**

```
ğŸ” Found 3 results for "react hooks"

1. ğŸ“„ React Hooks Complete Guide
   example.com/hooks-guide
   ğŸ†” abc-123 â€¢ Jan 10, 2025

2. ğŸ“¹ Understanding useEffect
   youtube.com/watch?v=xyz
   ğŸ†” def-456 â€¢ Jan 8, 2025

3. ğŸ“„ Custom Hooks Patterns
   dev.to/custom-hooks
   ğŸ†” ghi-789 â€¢ Jan 5, 2025

[Show More] [Open Site]
```

### 3.6 Statistics

**User sends `/stats`:**

```
ğŸ“Š Your Bookmarks

Total: 1,247 bookmarks
Unread: 890 (71%)
Favorites: 45

By Type:
ğŸ“„ Articles: 450
ğŸ“¹ Videos: 120
ğŸ’» Code: 80
ğŸ–¼ï¸ Images: 34
ğŸ“± Tweets: 28
ğŸ“„ Other: 535

Top Tags:
#javascript (145)
#python (89)
#tutorial (67)

Storage: 2.4 MB
Last saved: 2 hours ago
```

### 3.7 Error Messages

Clear, actionable error messages:

```
âŒ Couldn't fetch that page

The URL may be incorrect, the site may be down,
or it may require authentication.

Try again or save with custom title?

[ğŸ”„ Retry] [âœï¸ Custom Title] [âŒ Cancel]
```

```
âŒ Bookmark not found

ID: abc-123

This bookmark may have been deleted.
Use /recent to see your latest bookmarks.
```

```
âš ï¸ Rate limit exceeded

You can save 10 bookmarks per minute.
Wait 30 seconds and try again.
```

### 3.8 Inline Buttons

All actions use Telegram inline keyboards for better UX:
- Single tap to confirm/cancel
- No need to type commands
- Visual, intuitive interface
- Buttons update after action (âœ… becomes Saved!)

---

## 4. Cloudflare Worker

### 4.1 Endpoints

**POST /webhook**
- Telegram webhook handler
- Validates signature
- Routes commands to handlers
- Returns 200 immediately

**POST /api/bookmark**
- Create bookmark programmatically
- Authentication via bearer token
- Returns bookmark object

**PATCH /api/bookmark/{id}**
- Update bookmark fields
- Authentication required
- Returns updated bookmark

**DELETE /api/bookmark/{id}**
- Delete bookmark
- Authentication required
- Returns success status

**GET /api/health**
- Health check
- Returns: worker status, GitHub API status, last commit
- No authentication

**POST /api/import**
- Bulk import bookmarks
- Authentication required
- Accepts JSON array
- Returns import results

### 4.2 URL Processing

**Normalization:**
```
1. Convert to lowercase domain
2. Remove tracking parameters:
   - utm_* (all UTM parameters)
   - fbclid, gclid, msclkid
   - ref, source, campaign
   - mc_cid, mc_eid
3. Remove fragments (# anchors) unless essential
4. Sort remaining parameters alphabetically
5. Remove trailing slashes
6. Decode percent-encoding
```

**Redirect Resolution:**
```
1. Follow redirects (max 5 hops)
2. Timeout after 10 seconds
3. Handle common URL shorteners:
   - bit.ly, t.co, tinyurl.com
   - goo.gl, ow.ly
4. Store final URL as canonical_url
5. Keep original as url
```

**Hash Generation:**
```
1. Use canonical_url (or url if no redirect)
2. SHA-256 hash
3. Take first 16 characters
4. Use for deduplication
```

### 4.3 Metadata Extraction

**Extraction Pipeline:**
```
1. Fetch URL with custom user agent
   - User-Agent: BookmarkBot/1.0
   - Timeout: 5 seconds
   - Follow redirects: yes

2. Parse HTML with metascraper
   - Title: OG title â†’ Twitter title â†’ <title> â†’ URL
   - Description: OG description â†’ Twitter description â†’ meta description
   - Image: OG image â†’ Twitter image â†’ first <img>
   - Author: article:author â†’ meta author
   - Site name: OG site_name â†’ domain

3. Determine content type
   - YouTube/Vimeo: video
   - Twitter/X: tweet  
   - GitHub: code
   - imgur/pinterest: image
   - PDF extension: pdf
   - Article indicators: article
   - Default: other

4. Favicon
   - Check <link rel="icon">
   - Try /favicon.ico
   - Convert to base64 data URI
   - Fallback: generate from domain initials

5. Validation
   - Trim whitespace
   - Enforce character limits
   - HTML escape
   - Remove null bytes
```

**Timeout Handling:**
```
If extraction exceeds 5 seconds:
1. Cancel fetch
2. Save partial data:
   - title: URL host + path
   - content_type: other
   - extraction_status: timeout
3. Queue for retry (background job)
4. User gets "Saved with partial data" message
```

**Retry Logic:**
```
1. Store failed URL in Worker KV
2. Cron trigger: hourly
3. Retry up to 3 times
4. Update bookmark if successful
5. Remove from queue after 3 failures
```

### 4.4 GitHub Integration

**Authentication:**
- Fine-grained PAT with Contents: read/write on single repo
- Store in Worker secrets
- Include in Authorization header

**Read Operations:**
```javascript
GET /repos/{owner}/{repo}/contents/data/bookmarks.jsonl
- Parse JSON
- Check url_hash for duplicates
- Return existing bookmark if found
```

**Write Operations:**
```javascript
PUT /repos/{owner}/{repo}/contents/data/bookmarks.jsonl
- Get current file SHA
- Read existing JSON
- Perform operation:
  - Add: append to array
  - Update: find by ID, update fields, set modified_timestamp
  - Delete: filter out by ID
- Update metadata.json statistics
- Commit with descriptive message
- Commit format: "Add: {title}" or "Update: {title}" or "Delete: {title}"
```

**Conflict Resolution:**
```
On 409 Conflict:
1. Fetch latest file SHA
2. Retry operation with new SHA
3. Max 3 retry attempts
4. If still fails: queue for manual review
```

**Error Handling:**
```
404: Create new file
422: Validation error, notify user with details
403: Token expired, alert admin
5xx: Queue for retry, notify user "Temporarily unavailable"
```

### 4.5 Duplicate Detection

**Check Process:**
```
1. Normalize URL
2. Generate url_hash
3. Search bookmarks.jsonl for matching hash
4. If found:
   - Return existing bookmark
   - Show "already saved" message with option to save anyway
5. If "save anyway":
   - Allow duplicate (edge case: article republished, want both versions)
   - Add duplicate_of: original_id field
```

### 4.6 Worker KV Storage

**Usage:**
- Retry queue for failed extractions
- URL metadata cache (1 hour TTL)
- Rate limiting counters (1 minute TTL)
- Admin bearer tokens (hashed)

**Keys:**
```
retry:{uuid} â†’ {bookmark_object, attempts, next_retry}
cache:{url_hash} â†’ {metadata, cached_at}
ratelimit:{user_id}:{minute} â†’ {count}
token:{hash} â†’ {created_at, last_used}
```

---

## 5. Static Site

### 5.1 Interface Layout

**Desktop (>1024px):**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ”– My Bookmarks              [Search...    ğŸ”] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [All] [Unread] [Favorites] [Private]           â”‚
â”‚ Type: [All â–¾] Tags: [All â–¾] Sort: [Newest â–¾]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚ â”‚ [Image] â”‚ â”‚ [Image] â”‚ â”‚ [Image] â”‚  3-col    â”‚
â”‚ â”‚ Title   â”‚ â”‚ Title   â”‚ â”‚ Title   â”‚  grid     â”‚
â”‚ â”‚ Desc... â”‚ â”‚ Desc... â”‚ â”‚ Desc... â”‚           â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Mobile (<640px):**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”– Bookmarks   [â˜°] â”‚
â”‚ [Search......  ğŸ”] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ < Unread >          â”‚ Horizontal scroll
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ [Image]         â”‚ â”‚ 1-col
â”‚ â”‚ Title           â”‚ â”‚ list
â”‚ â”‚ Description...  â”‚ â”‚
â”‚ â”‚ 2d ago Â· ğŸ·ï¸ tag â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ [Image]         â”‚ â”‚
```

### 5.2 Bookmark Card

**Compact Card (Browse Mode):**
```html
<article class="bookmark-card" data-id="{id}">
  <img src="{image}" alt="" loading="lazy" />
  <div class="bookmark-content">
    <h3><a href="{url}" target="_blank">{title}</a></h3>
    <p class="description">{description}</p>
    <div class="metadata">
      <span class="type">{icon} {content_type}</span>
      <time datetime="{timestamp}">{relative_time}</time>
      <span class="site">{site_name}</span>
    </div>
    <div class="tags">
      {#each tags}
        <span class="tag">{tag}</span>
      {/each}
    </div>
  </div>
  <div class="actions">
    <button class="favorite" aria-label="Favorite">â­</button>
    <button class="more" aria-label="More">â‹¯</button>
  </div>
</article>
```

**More Actions Menu:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœï¸ Edit             â”‚
â”‚ ğŸ·ï¸ Add Tag          â”‚
â”‚ ğŸ“ Add Note         â”‚
â”‚ âœ… Mark as Read     â”‚
â”‚ ğŸ”’ Make Private     â”‚
â”‚ ğŸ—‘ï¸ Delete           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.3 Filters & Sorting

**Read Status Filter:**
- All (default)
- Unread (badge with count)
- Reading (in progress)
- Read (archived)

**Content Type Filter:**
- All
- ğŸ“„ Articles
- ğŸ“¹ Videos
- ğŸ’» Code
- ğŸ–¼ï¸ Images
- ğŸ“± Tweets
- ğŸ“„ Other

**Tag Filter:**
- Multi-select dropdown
- Shows all tags with counts
- "No tags" option
- Search tags (if >20 tags)

**Sort Options:**
- Newest first (default)
- Oldest first
- Recently modified
- Title A-Z
- Most relevant (search results only)

**Special Views:**
- Favorites (â­ icon, filtered)
- Private (ğŸ”’ icon, needs auth)
- Unread (badge count)

### 5.4 Search with Pagefind

**Search Bar:**
- Sticky at top on scroll
- Autofocus on page load (desktop)
- Clear button (Ã—)
- Search on Enter or 300ms debounce
- Shows result count

**Search Results:**
- Highlights matching terms
- Excerpts around matches
- Ranked by relevance
- Same card design as browse mode
- "Load more" button (pagination)

**Search Syntax:**
```
Query: "react hooks"          â†’ Phrase search
Query: react AND hooks        â†’ Both terms required
Query: react OR vue           â†’ Either term
Query: react -angular         â†’ Exclude term
Query: tag:javascript         â†’ Filter by tag
Query: type:article           â†’ Filter by type
Query: site:example.com       â†’ Filter by domain
```

**Filters Applied to Search:**
- Content type
- Tags
- Read status
- All filters work with search

### 5.5 Empty States

**No Bookmarks:**
```
ğŸ“­ No bookmarks yet

Get started by sending a link to your
Telegram bot: @yourbookmarkbot

[How to Setup]
```

**No Search Results:**
```
ğŸ” No results for "{query}"

Try:
â€¢ Checking your spelling
â€¢ Using different keywords
â€¢ Removing filters
â€¢ Searching all bookmarks (not just unread)
```

**No Unread:**
```
ğŸ‰ You're all caught up!

All bookmarks marked as read.

[Browse All] [View Favorites]
```

### 5.6 Loading States

**Initial Load:**
```
â³ Loading bookmarks...
```

**Search in Progress:**
```
ğŸ” Searching...
(Shown in search bar)
```

**Lazy Load More:**
```
Loading more bookmarks...
(Spinner at bottom of list)
```

**Saving Edit:**
```
ğŸ’¾ Saving...
(Button changes to spinner)
```

### 5.7 Mobile UX Details

**Touch Targets:**
- Minimum 44Ã—44px for all buttons
- Card entire area tappable (opens URL)
- Swipe left on card reveals quick actions:
  - â­ Favorite
  - âœ… Mark Read
  - ğŸ—‘ï¸ Delete

**Pull to Refresh:**
- Pull down on bookmark list
- Shows spinner
- Fetches latest bookmarks.jsonl
- Updates view

**Search on Mobile:**
- Search icon in header
- Tapping opens overlay with search
- Recent searches shown
- Easy to close (back or Ã—)

**Bottom Navigation (Mobile):**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [ğŸ  Browse] [â­ Favorites] [â˜°]  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Keyboard:**
- Dismisses when scrolling
- Submit search on Enter
- Clear button always visible

### 5.8 Accessibility

**Keyboard Navigation:**
- Tab through all interactive elements
- Enter to activate buttons/links
- Escape to close modals
- Arrow keys in dropdown menus

**Screen Reader:**
- Semantic HTML (article, nav, main)
- ARIA labels on icon buttons
- Alt text on images (title as alt)
- Live region announces search results count

**Focus Management:**
- Visible focus indicators
- Focus trapped in modals
- Focus returns after modal closes

**Color Contrast:**
- WCAG AA minimum (4.5:1 for text)
- Color not sole indicator (icons + text)
- Dark mode support

### 5.9 Performance

**Lazy Loading:**
- Images: native loading="lazy"
- Bookmarks: virtualized scrolling for >1000
- Pagefind: loads indexes on-demand

**Caching:**
- Service Worker caches bookmarks.jsonl (1 hour)
- Pagefind indexes cached (7 days)
- Static assets cached (1 year)

**Optimizations:**
- Minified CSS/JS
- Compressed assets (gzip)
- Pagefind pre-built indexes (no runtime building)
- Responsive images (srcset)

**Metrics:**
- First Contentful Paint: <1s
- Time to Interactive: <2s
- Search response: <300ms

---

## 6. GitHub Actions

### 6.1 Build Workflow

**Trigger:**
- Push to main with changes in `data/bookmarks.jsonl`
- Manual workflow dispatch

**Steps:**

```yaml
name: Build Pagefind Index

on:
  push:
    branches: [main]
    paths: ['data/bookmarks.jsonl']
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
      
      - name: Generate HTML pages
        run: node scripts/generate-pages.js
        # Reads bookmarks.jsonl
        # Creates pages/{id}.html for each bookmark
        # Includes title, description, tags, URL
        
      - name: Install Pagefind
        run: npx pagefind --version
      
      - name: Build search index
        run: npx pagefind --site .
        # Indexes all HTML in pages/
        # Outputs to pagefind/
      
      - name: Update metadata
        run: node scripts/update-metadata.js
        # Updates metadata.json with statistics
      
      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add pagefind/ metadata.json
          git diff --quiet && git diff --staged --quiet || git commit -m "Build search index"
          git push
      
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .
```

### 6.2 Generate Pages Script

**Purpose:** Convert bookmarks to HTML pages for Pagefind indexing

**Script Logic:**
```javascript
const bookmarks = JSON.parse(fs.readFileSync('data/bookmarks.jsonl'));

for (const bookmark of bookmarks) {
  if (bookmark.is_private) continue; // Skip private
  
  const html = `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="UTF-8">
      <title>${escapeHtml(bookmark.title)}</title>
    </head>
    <body>
      <article data-pagefind-body>
        <h1>${escapeHtml(bookmark.title)}</h1>
        <p>${escapeHtml(bookmark.description || '')}</p>
        <a href="${bookmark.url}">${bookmark.url}</a>
        <time>${bookmark.timestamp}</time>
        <div data-pagefind-meta="type">${bookmark.content_type}</div>
        <div data-pagefind-meta="tags">${bookmark.tags.join(', ')}</div>
        <div data-pagefind-meta="site">${bookmark.site_name}</div>
        ${bookmark.notes ? `<div data-pagefind-body>${bookmark.notes}</div>` : ''}
      </article>
    </body>
    </html>
  `;
  
  fs.writeFileSync(`pages/${bookmark.id}.html`, html);
}
```

### 6.3 Validation Workflow

**Trigger:** Daily at midnight UTC

**Checks:**
- All bookmark IDs unique
- No future timestamps
- All required fields present
- Valid URLs
- Tags exist in tags.json
- File sizes reasonable (<10MB)
- Valid JSON structure

**On Failure:**
- Create GitHub Issue with details
- Send Telegram alert to admin
- Don't block deployment

### 6.4 Backup Workflow

**Trigger:** Weekly on Sunday

**Actions:**
- Create timestamped backup of bookmarks.jsonl
- Store in GitHub Releases
- Keep last 12 backups (3 months)

---

## 7. Client-Side Application

### 7.1 State Management

**App State:**
```javascript
{
  bookmarks: [],           // Loaded bookmarks
  filters: {
    readStatus: 'all',     // all|unread|reading|read
    contentType: 'all',    // all|article|video|etc
    tags: [],              // Array of selected tags
    showPrivate: false,    // Toggle private bookmarks
    showFavorites: false   // Toggle favorites only
  },
  sort: 'newest',          // newest|oldest|modified|title
  searchQuery: '',         // Current search
  view: 'browse',          // browse|search
  loading: false,
  error: null
}
```

### 7.2 Initialization Flow

```javascript
1. Load bookmarks.jsonl
2. Check if authenticated (for private bookmarks)
3. Apply URL parameters (filters from URL)
4. Initialize Pagefind
5. Render initial view (browse mode)
6. Focus search bar (desktop)
7. Register service worker (offline support)
```

### 7.3 Browse Mode

**Display Logic:**
```javascript
1. Apply filters to bookmarks array
2. Sort by selected option
3. Render first 20 bookmarks
4. Initialize Intersection Observer for lazy load
5. When scrolling near bottom:
   - Load next 20 bookmarks
   - Append to DOM
```

### 7.4 Search Mode

**Search Flow:**
```javascript
1. User types in search bar (debounced 300ms)
2. Switch to search view
3. Call Pagefind API: pagefind.search(query)
4. Get result IDs and excerpts
5. Load full bookmark data for results
6. Apply current filters to results
7. Render results with highlighted excerpts
8. Show result count
```

### 7.5 Filter Changes

**Immediate Filter Update:**
```javascript
1. Update state.filters
2. Re-filter current bookmarks (instant)
3. Re-render list
4. Update URL parameters (for sharing)
5. Save filter preferences to localStorage
```

### 7.6 Actions

**Favorite Toggle:**
```javascript
1. Update UI immediately (optimistic)
2. POST /api/bookmark/{id} with is_favorite: true/false
3. On success: no change
4. On error: revert UI, show toast
```

**Mark as Read:**
```javascript
1. Fade card slightly (visual feedback)
2. PATCH /api/bookmark/{id} with read_status: 'read'
3. On success: move to read section if in unread view
4. On error: revert, show error
```

**Delete:**
```javascript
1. Show confirmation modal
2. On confirm:
   - Remove card from DOM with animation
   - DELETE /api/bookmark/{id}
   - On error: restore card, show error
```

**Edit:**
```javascript
1. Show inline edit form in card
2. User edits title/description/tags
3. On save:
   - Update card immediately
   - PATCH /api/bookmark/{id}
   - On error: revert, show error
```

### 7.7 Offline Support

**Service Worker:**
```javascript
Cache Strategy:
- bookmarks.jsonl: Network first, fallback to cache (1 hour)
- Static assets: Cache first
- Pagefind indexes: Cache first (7 days)
- API calls: Network only (no cache)

Offline Behavior:
- Browse mode works (shows cached bookmarks)
- Search works (uses cached indexes)
- Actions queued (saved when online)
- Banner: "You're offline. Changes will sync when online."
```

### 7.8 URL Parameters

**Filter Sharing:**
```
?view=search&q=react&type=article&tags=javascript,tutorial&status=unread&sort=newest

Supported params:
- view: browse|search
- q: search query
- type: content type filter
- tags: comma-separated tags
- status: read status filter
- sort: sort option
- favorite: true (show favorites only)
```

### 7.9 Keyboard Shortcuts

**Global:**
- `/` or `Ctrl+K`: Focus search
- `Esc`: Clear search / close modal
- `?`: Show keyboard shortcuts help

**Browse Mode:**
- `j/k`: Next/previous bookmark
- `o`: Open highlighted bookmark
- `f`: Toggle favorite
- `d`: Delete (with confirmation)
- `r`: Mark as read

**Search Mode:**
- `â†‘/â†“`: Navigate results
- `Enter`: Open result
- `Esc`: Clear search

---

## 8. Security & Privacy

### 8.1 Authentication

**Telegram Bot:**
- Webhook signature verification (required)
- User ID allowlist (environment variable)
- Rate limiting per user
- Log all authentication attempts

**API Endpoints:**
- Bearer token authentication
- Tokens stored hashed in Worker KV
- Token rotation support
- Per-token rate limiting

**GitHub Token:**
- Fine-grained PAT
- Minimum scope: Contents read/write
- Single repository access
- Rotate every 90 days
- Store in Cloudflare secrets

### 8.2 Private Bookmarks

**Storage:**
- Marked with is_private: true
- Excluded from public HTML pages generation
- Not indexed by Pagefind
- Stored in same bookmarks.jsonl (but filtered)

**Access Control:**
- Viewing private requires authentication
- Simple password protection option
- Or GitHub OAuth for single user
- localStorage stores auth token

**Implementation:**
```javascript
// Client-side check
if (bookmark.is_private && !isAuthenticated()) {
  return; // Don't render
}

// Build script
if (bookmark.is_private) {
  continue; // Don't generate HTML page
}
```

### 8.3 Data Sanitization

**All Text Fields:**
```javascript
function sanitize(text) {
  return text
    .trim()
    .replace(/[\x00-\x1F\x7F]/g, '') // Remove control chars
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#x27;')
    .slice(0, MAX_LENGTH);
}
```

**URL Validation:**
```javascript
function validateUrl(url) {
  try {
    const parsed = new URL(url);
    if (!['http:', 'https:'].includes(parsed.protocol)) {
      return false;
    }
    // Reject private IPs
    if (/^(10|127|172\.(1[6-9]|2[0-9]|3[01])|192\.168)\./.test(parsed.hostname)) {
      return false;
    }
    return true;
  } catch {
    return false;
  }
}
```

### 8.4 Rate Limiting

**Per User (Telegram):**
- 10 bookmarks per minute
- 100 bookmarks per day
- Tracked in Worker KV with TTL

**Per Token (API):**
- 60 requests per hour
- Burst: 10 requests in 10 seconds

**Implementation:**
```javascript
// Worker KV key
const key = `ratelimit:${userId}:${currentMinute}`;
const count = await KV.get(key) || 0;

if (count >= 10) {
  return new Response('Rate limit exceeded', { status: 429 });
}

await KV.put(key, count + 1, { expirationTtl: 60 });
```

### 8.5 Content Security Policy

```html
<meta http-equiv="Content-Security-Policy" 
  content="
    default-src 'self';
    script-src 'self' 'unsafe-inline';
    style-src 'self' 'unsafe-inline';
    img-src 'self' https: data:;
    connect-src 'self';
  ">
```

---

## 9. Error Handling & Resilience

### 9.1 Worker Error Handling

**Metadata Extraction Failures:**
```javascript
try {
  metadata = await extractMetadata(url, { timeout: 5000 });
} catch (error) {
  if (error.name === 'TimeoutError') {
    metadata = {
      title: new URL(url).hostname,
      extraction_status: 'timeout',
      extraction_error: 'Extraction timed out'
    };
    queueForRetry(url, bookmark);
  } else if (error.code === 'ENOTFOUND') {
    throw new Error('URL not found or inaccessible');
  } else {
    metadata = {
      title: url,
      extraction_status: 'failed',
      extraction_error: error.message
    };
  }
}
```

**GitHub API Errors:**
```javascript
try {
  await commitToGitHub(bookmark);
} catch (error) {
  if (error.status === 409) {
    // Conflict - retry with latest SHA
    return retryWithExponentialBackoff(() => commitToGitHub(bookmark), 3);
  } else if (error.status >= 500) {
    // GitHub down - queue for retry
    await queueBookmark(bookmark);
    return { queued: true, message: 'Temporarily unavailable. Will retry.' };
  } else if (error.status === 403) {
    // Rate limit or auth issue
    await alertAdmin('GitHub API issue', error);
    throw new Error('System error. Admin notified.');
  }
}
```

### 9.2 Client Error Handling

**Network Errors:**
```javascript
try {
  response = await fetch('/api/bookmark');
} catch (error) {
  if (navigator.onLine === false) {
    showToast('You\'re offline. Change saved locally and will sync when online.');
    queueAction(action);
  } else {
    showToast('Network error. Please try again.');
  }
}
```

**Validation Errors:**
```javascript
if (response.status === 400) {
  const error = await response.json();
  showToast(`Invalid: ${error.field} - ${error.message}`);
  highlightField(error.field);
}
```

### 9.3 Retry Mechanisms

**Exponential Backoff:**
```javascript
async function retryWithBackoff(fn, maxAttempts = 3) {
  for (let attempt = 1; attempt <= maxAttempts; attempt++) {
    try {
      return await fn();
    } catch (error) {
      if (attempt === maxAttempts) throw error;
      await sleep(Math.pow(2, attempt) * 1000);
    }
  }
}
```

**Background Retry Queue:**
```javascript
// Cron trigger: every hour
async function processRetryQueue() {
  const queued = await getQueuedBookmarks();
  
  for (const item of queued) {
    if (item.attempts >= 3) {
      await alertUser('Failed to save bookmark', item);
      await removeFromQueue(item.id);
      continue;
    }
    
    try {
      await commitToGitHub(item.bookmark);
      await removeFromQueue(item.id);
      await notifyUser('Bookmark saved', item);
    } catch (error) {
      item.attempts++;
      item.next_retry = Date.now() + (60 * 60 * 1000); // 1 hour
      await updateQueue(item);
    }
  }
}
```

### 9.4 Data Validation

**On Save:**
```javascript
function validateBookmark(bookmark) {
  const errors = [];
  
  if (!bookmark.url || !validateUrl(bookmark.url)) {
    errors.push('Invalid URL');
  }
  if (!bookmark.title || bookmark.title.length > 200) {
    errors.push('Title required, max 200 characters');
  }
  if (bookmark.description && bookmark.description.length > 500) {
    errors.push('Description max 500 characters');
  }
  if (!['article','video','image','pdf','code','tweet','other'].includes(bookmark.content_type)) {
    errors.push('Invalid content type');
  }
  
  return errors;
}
```

**On Build:**
```javascript
function validateBookmarksFile(bookmarks) {
  const ids = new Set();
  
  for (const bookmark of bookmarks) {
    if (ids.has(bookmark.id)) {
      throw new Error(`Duplicate ID: ${bookmark.id}`);
    }
    ids.add(bookmark.id);
    
    if (new Date(bookmark.timestamp) > new Date()) {
      throw new Error(`Future timestamp: ${bookmark.id}`);
    }
  }
}
```

### 9.5 Graceful Degradation

**No JavaScript:**
- Shows recent 50 bookmarks
- No search (shows message with Telegram bot search command)
- Links work, opens in new tab

**Old Browser:**
- Polyfills for fetch, Promise
- Fallback for Intersection Observer
- CSS Grid fallback to Flexbox

**Pagefind Fails to Load:**
- Fall back to client-side text search
- Slower but functional
- Show banner: "Search index unavailable"

---

## 10. Monitoring & Analytics

### 10.1 Worker Metrics

**Cloudflare Analytics:**
- Request count (per endpoint)
- Response times (p50, p95, p99)
- Error rate (4xx, 5xx)
- Data transfer

**Custom Metrics:**
- Bookmarks saved per day
- Metadata extraction success rate
- GitHub API error rate
- Retry queue size
- Average extraction time

### 10.2 Alerts

**Critical (Telegram):**
- Worker error rate >5% for 5 minutes
- GitHub API rate limit <100
- Retry queue >50 items
- Authentication failures spike

**Warning (Email):**
- Extraction success rate <80%
- Build time >5 minutes
- bookmarks.jsonl size approaching 10MB

### 10.3 Logs

**Worker Logs:**
```javascript
{
  timestamp: "2025-01-12T10:30:00Z",
  level: "INFO",
  action: "save_bookmark",
  user_id: "123456789",
  url: "https://example.com",
  extraction_time_ms: 1250,
  status: "success",
  bookmark_id: "abc-123"
}
```

**Error Logs:**
```javascript
{
  timestamp: "2025-01-12T10:30:00Z",
  level: "ERROR",
  action: "save_bookmark",
  error: "GitHub API timeout",
  error_code: 504,
  user_id: "123456789",
  url: "https://example.com",
  stack: "..."
}
```

### 10.4 Health Checks

**GET /api/health Response:**
```json
{
  "status": "healthy",
  "worker": {
    "status": "ok",
    "uptime_ms": 3600000
  },
  "github": {
    "status": "ok",
    "rate_limit_remaining": 4850,
    "last_commit": "2025-01-12T10:25:00Z"
  },
  "kv": {
    "status": "ok",
    "retry_queue_size": 2
  },
  "build": {
    "status": "ok",
    "last_build": "2025-01-12T10:20:00Z",
    "duration_ms": 45000
  }
}
```

---

## 11. Import & Migration

### 11.1 Import from Google Keep

**Export Process:**
1. Use Google Takeout
2. Download Keep data as JSON
3. Run import script

**Import Script:**
```bash
node scripts/import-google-keep.js takeout.json

Options:
--dry-run: Preview import
--skip-metadata: Faster, no URL fetching
--tag: Add tag to all imports (e.g., "from-keep")
```

**Mapping:**
```javascript
{
  title: note.title || extractTitleFromBody(note.textContent),
  description: note.textContent.slice(0, 500),
  tags: note.labels.map(l => l.name),
  timestamp: note.createdTimestampUsec / 1000,
  url: extractFirstUrl(note.textContent)
}
```

### 11.2 Import from Other Services

**Supported Formats:**
- Pinboard JSON export
- Pocket HTML export
- Browser bookmarks HTML
- Instapaper CSV
- Raindrop.io JSON

**Generic Import:**
```bash
node scripts/import.js \
  --format pinboard \
  --file export.json \
  --extract-metadata \
  --tag imported

Output:
âœ… 245 bookmarks imported
âš ï¸ 12 duplicates skipped
âŒ 3 failed (URLs inaccessible)
```

### 11.3 Export

**Export Formats:**
```bash
# HTML (browser bookmarks format)
node scripts/export.js --format html --output bookmarks.html

# JSON (raw data)
node scripts/export.js --format json --output bookmarks.jsonl

# CSV (spreadsheet)
node scripts/export.js --format csv --output bookmarks.csv

# Markdown (readable)
node scripts/export.js --format markdown --output bookmarks.md
```

---

## 12. Development & Deployment

### 12.1 Local Development

**Setup:**
```bash
# Clone repo
git clone https://github.com/username/bookmarks.git
cd bookmarks

# Install dependencies
npm install

# Set environment variables
cp .env.example .env
# Edit .env with your tokens

# Run Worker locally
wrangler dev

# Build site
npm run build

# Serve locally
npm run serve
```

**Testing Webhook Locally:**
```bash
# Use ngrok to expose local Worker
ngrok http 8787

# Set Telegram webhook
curl https://api.telegram.org/bot{TOKEN}/setWebhook?url=https://xxx.ngrok.io/webhook
```

### 12.2 Production Deployment

**One-time Setup:**
```bash
# Deploy Worker
wrangler deploy

# Set secrets
wrangler secret put TELEGRAM_BOT_TOKEN
wrangler secret put GITHUB_TOKEN

# Configure webhook
curl https://api.telegram.org/bot{TOKEN}/setWebhook?url=https://worker.username.workers.dev/webhook

# Enable GitHub Pages
# In repo settings: Pages â†’ Source: GitHub Actions
```

**Updates:**
```bash
# Update Worker
wrangler deploy

# Update site (automatic on push)
git push origin main
```

### 12.3 Environment Variables

**Cloudflare Worker:**
```bash
TELEGRAM_BOT_TOKEN="bot123456:ABC..."
TELEGRAM_USER_ID="123456789"
GITHUB_TOKEN="ghp_..."
GITHUB_REPO="username/bookmarks"
WEBHOOK_SECRET="random32chars"
```

**GitHub Secrets (for Actions):**
```bash
TELEGRAM_BOT_TOKEN  # For status notifications
```

### 12.4 Rollback

**Worker:**
```bash
wrangler rollback --message "Revert to previous version"
```

**Site:**
```bash
git revert HEAD
git push origin main
# GitHub Actions rebuilds automatically
```

**Data Recovery:**
```bash
# Restore from backup
git checkout origin/main data/bookmarks.jsonl
git push origin main
```

---

## 13. Cost Analysis

### 13.1 Free Tier Limits

| Service | Free Tier | Expected Usage | Overage Cost |
|---------|-----------|----------------|--------------|
| Cloudflare Workers | 100k requests/day | ~300/day | $0.50/million |
| Worker KV | 1GB storage, 1k writes/day | ~100 writes/day | $0.50/GB storage |
| GitHub Actions | 2000 min/month | ~50 min/month | $0.008/minute |
| GitHub Pages | 1GB storage, 100GB bandwidth | ~50MB, ~5GB | N/A |
| GitHub API | 5000 req/hour | ~200/hour | N/A |

**Total Monthly Cost:** $0

### 13.2 Scale Projections

**1,000 bookmarks:**
- Storage: ~500KB JSON + 50MB HTML pages
- Builds: ~30 seconds
- Well within free tiers

**10,000 bookmarks:**
- Storage: ~5MB JSON + 500MB HTML pages
- Builds: ~3 minutes
- Still within free tiers
- May want to implement sharding

**100,000 bookmarks:**
- Storage: ~50MB JSON + 5GB HTML pages
- Builds: ~20 minutes
- Approaching limits
- Recommend: sharding, separate index repo

---

## 14. Documentation

### 14.1 User Documentation

**README.md:**
- What is this system
- Features overview
- Screenshots
- Quick start guide
- Telegram bot commands

**SETUP.md:**
- Detailed setup instructions
- Prerequisites
- Step-by-step deployment
- Troubleshooting

**COMMANDS.md:**
- All Telegram commands
- Examples with screenshots
- Tips and tricks

**FAQ.md:**
- Common questions
- How to solve issues
- Feature requests

### 14.2 Developer Documentation

**ARCHITECTURE.md:**
- System design
- Data flow diagrams
- Technology choices
- Scaling considerations

**API.md:**
- Worker endpoints
- Request/response formats
- Authentication
- Rate limits

**CONTRIBUTING.md:**
- How to contribute
- Code style guide
- Running tests
- Pull request process

### 14.3 Operational

**MONITORING.md:**
- What to monitor
- Setting up alerts
- Understanding metrics
- Dashboards

**BACKUP.md:**
- Backup strategy
- Restore procedures
- Testing backups

**SECURITY.md:**
- Security best practices
- Token rotation
- Incident response

---

## 15. Future Enhancements

### 15.1 Phase 2 (Month 2-3)

- **Browser Extension:** Save from any page with one click
- **Full-text Archive:** Save complete page HTML/PDF
- **Collections:** Group related bookmarks
- **Sharing:** Public collections with unique URLs
- **RSS Feed:** Subscribe to new bookmarks
- **Email Digest:** Weekly summary of saved bookmarks

### 15.2 Phase 3 (Month 4-6)

- **Annotations:** Highlight and comment on bookmarks
- **Related Links:** Show similar bookmarks
- **Reading Time:** Estimate from word count
- **Reading Progress:** Track % read for long articles
- **Recommendations:** ML-based suggestions
- **API Documentation:** Public API with OAuth

### 15.3 Technical Debt

- **Testing:** Unit tests, integration tests, E2E tests
- **Performance:** Optimize large dataset handling
- **Accessibility:** Full WCAG 2.1 AA compliance
- **Internationalization:** Multi-language support
- **Mobile Apps:** Native iOS/Android apps

---

## Implementation Timeline

### Week 1: Foundation
- Set up repo structure
- Create Telegram bot
- Deploy basic Worker (webhook + echo)
- Create basic HTML page
- Test end-to-end flow

### Week 2: Core Features
- Implement metadata extraction
- GitHub integration (read/write)
- Duplicate detection
- Preview flow in Telegram
- Error handling

### Week 3: Site & Search
- Build script (bookmarks â†’ HTML pages)
- Integrate Pagefind
- Implement filters
- Browse mode UI
- Mobile responsive

### Week 4: Polish
- Edit/delete/tag commands
- Inline actions on cards
- Loading states
- Error messages
- Keyboard shortcuts

### Week 5: Advanced Features
- Private bookmarks
- Favorites
- Read status
- Notes
- Collections

### Week 6: Testing & Deploy
- Write tests
- Load testing
- Security review
- Documentation
- Production deployment

---

**Status:** Complete production specification  
**Ready for:** Implementation
